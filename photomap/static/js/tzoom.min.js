(function(a,b){a.widget("ui.tzoom",{version:"1.0",options:{image:null,imageSrc:null,lazySrc:null,loadingImage:null,loadingImageSrc:null,slider:null,decreaseBtn:null,increaseBtn:null,wheelEnabled:true,buttonStep:25,wheelStep:15,easing:"swing",duration:300,wheelEasing:"swing",wheelDuration:150,fadeIn:"slow",zoomCursor:"move",staticCursor:"auto",fixed:false,scaleUp:false,onLoad:null,onLazy:null,onReady:null,onZoom:null,onZoomed:null,onError:null},_create:function(){var d=this,e=this.element,c;e.addClass("tzoom-viewport");this._val=0;this._view={top:0,left:0,width:this.options.fixed?e.width():Math.max(e.width(),e.height()),height:this.options.fixed?e.height():Math.max(e.width(),e.height())};this._setDimensions();this._sliderMoved=null;this._disabled=true;if(this.options.slider){this._setSlider(this.options.slider)}if(this.options.decreaseBtn){this._setDecreaseBtn(this.options.decreaseBtn)}if(this.options.increaseBtn){this._setIncreaseBtn(this.options.increaseBtn)}if(typeof a.event.special.mousewheel!="undefined"){c=function(f,g){d._onMousewheel(f,g)};this.element.mousewheel(c);if(this.options.slider){a(this.options.slider).mousewheel(c)}}if(this.options.image){this.image(this.options.image)}else{if(this.options.imageSrc){this.imageSrc(this.options.imageSrc)}}if(!this.options.onError){this.options.onError=function(){d._error.call(d)}}this.disable()},_setOption:function(c,d){switch(c){case"imageSrc":this.imageSrc(d);break;case"image":this.image(d);break;case"slider":this._setSlider(d);break;case"decreaseBtn":this._setDecreaseBtn(d);break;case"increaseBtn":this._setIncreaseBtn(d);break}a.Widget.prototype._setOption.apply(this,arguments)},_setSlider:function(d){var c=this;if(this.options.slider){this._destroyControl(this.options.slider)}this.options.slider=d;if(d){a(d).slider({min:0,max:100,step:1,change:function(e,f){if(!c._sliderMoved){c.value(f.value)}else{delete c._sliderMoved}}});a(d).addClass("tzoom-control")}},_setDecreaseBtn:function(c){var d=this;if(this.options.decreaseBtn){this._destroyControl(this.options.decreaseBtn)}this.options.decreaseBtn=c;if(c){a(c).click(function(f,g){var e=d._val-d.options.buttonStep;d.value(e)});a(c).addClass("tzoom-control")}},_setIncreaseBtn:function(d){var e=this,c;if(this.options.increaseBtn){this._destroyControl(this.options.increaseBtn)}this.options.increaseBtn=d;if(d){a(d).click(function(f,g){c=e._val+e.options.buttonStep;e.value(c)});a(d).addClass("tzoom-control")}},_onMousewheel:function(e,g){if(this.options.wheelEnabled&&g){var f,c;e.preventDefault();f=g>0?Math.ceil(g):Math.floor(g);c=this._val+(f*this.options.wheelStep);this.value(c,{duration:this.options.wheelDuration,easing:this.options.wheelEasing})}return false},_moveSlider:function(c){if(this.options.slider&&!this._disabled){this._sliderMoved=true;a(this.options.slider).slider("value",c)}},_value:function(c){if(!c&&c!==0){return false}if(this._val==0&&c<=0){return false}if(this._val==100&&c>=100){return false}this._val=Math.min(Math.max(c,0),100);return true},_zoom:function(i){i=i||{};var f=this,e=this._size(),d=a(this._img),h,k,j,g;j=i.easing?i.easing:this.options.easing;g=i.duration?i.duration:this.options.duration;if(e.width!=d.width()){h=this._position();k=this._containment();d.animate(a.extend({},h,e),g,j,function(){d.draggable("option","containment",k);if(f.options.onZoomed){f.options.onZoomed.call(d,f._val)}})}},_testImage:function(d){var c=a(d);if(this._img&&c.attr("src")==this._img.attr("src")){return false}else{if(!c.length){this._clear();return false}else{return true}}},_image:function(d,c){this.element.find(".tzoom-error").remove();delete this.options.lazySrc;this._img=a(d);if(c){this.options.lazySrc=c}},_prepareImage:function(d){var g=this,h=this.element,i,c,f,e;this._img.hide();this._clearValues();this.disable();if(!d){h.find(".tzoom-image").remove()}if(!this._img.get(0).complete){this._loadingImage()}if(this.options.onError){this._img.error(this.options.onError)}this._load(this._img,function(){g._loadingImage(true);i=g._setDimensions(g._img);c=g._view;if(g.options.onLoad){g.options.onLoad.call(g._img)}if(!g.options.fixed||c.width!=h.width()||c.height!=h.height()){f=g._aspectRatio(i.max.width,i.max.height);e=g._viewportBounds(f);g.element.animate(e,g.options.duration,g.options.easing,function(){g._onViewportReady(d)})}else{g._onViewportReady(d)}})},_onViewportReady:function(g){this.element.append(this._img);var h=this,f=a(this._img),j=this._position(),e=this._size(),d,c;d=a.extend({},j,e);c=this._dim.diff.width>=0||this._dim.diff.height>=0;this.element.find(".tzoom-image").remove();f.addClass("tzoom-image");if(c||this.isProxy()){f.css(d);f.css("cursor",this.options.zoomCursor);if(!this.isProxy()){f.draggable({cursor:this.options.zoomCursor,containment:this._containment()})}this.enable()}else{if(this.options.scaleUp){f.css(d)}else{this._centerImage(f)}this.disable();f.removeClass("tzoom-disabled");f.addClass("tzoom-image-static");f.css("cursor",this.options.staticCursor)}if(g){f.show();g.call(this);if(this.options.onReady){this.options.onReady.call(f,c)}}else{f.fadeIn(this.options.fadeIn,function(){if(h.options.onReady){h.options.onReady.call(f,c)}})}},_loadingImage:function(d){var e=this,c;if(!d){if(this._loadingImg){return}if(this.options.loadingImage){c=a(this.options.loadingImage).hide()}else{if(this.options.loadingImageSrc){c=a("<img />").attr("src",this.options.loadingImageSrc).hide()}}if(c&&c.length){this._loadingImg=c;this._load(c,function(){if(e.element.find(".tzoom-error").length==0){c.addClass("tzoom-image-loading");c.show();e._centerImage(c,true);e.element.append(c)}})}}else{if(this._loadingImg){this._loadingImg.remove();delete this._loadingImg}}},_centerImage:function(f,n){var j=new Image(),i=this.element,m=i.height(),c=i.width(),g,k,l,d,h;j.src=a(f).attr("src");g=j.height;k=j.width;l=((m-g)*0.5);d=((c-k)*0.5);if(n){h=this.element.find(".tzoom-image");if(h.length&&h.is(":visible")){l-=h.height()}}f.css({top:l,left:d})},_load:function(c,d){if(c){if(c.get(0).complete){d.call(this)}else{c.load(d)}}},_error:function(){var f=a("<div></div>"),c=a("<span></span>"),e=a("<strong></strong>"),d=a("<p></p>");f.addClass("tzoom-error").addClass("ui-state-error").addClass("ui-corner-all");c.addClass("ui-icon").addClass("ui-icon-alert");e.html("Unable to load zoom image.");f.append(d);d.append(c);d.append(e);this.element.find(".tzoom-image-loading").remove();this.element.append(f)},_setDimensions:function(k){var j,h=this.element,d=a(k),l=new Image(),g,c,f;j={max:{width:0,height:0},min:{width:0,height:0},diff:{width:0,height:0}};j.toString=function(){return"max.width: "+this.max.width+", max.height: "+this.max.height+", min.width: "+this.min.width+", min.height: "+this.min.height+", diff.width: "+this.diff.width+", diff.height: "+this.diff.height};if(k){l.src=d.attr("src");j.max.width=l.width;j.max.height=l.height;g=this._aspectRatio(j.max.width,j.max.height);c=Math.max(this._view.width,this._view.height);f=Math.min(this._view.width,this._view.height);j.min.width=Math.round(c*g.width),j.min.height=Math.round(c*g.height);if(j.min.width>h.width()||j.min.height>h.height()){j.min.width=Math.round(f*g.width);j.min.height=Math.round(f*g.height)}j.diff.width=j.max.width-j.min.width,j.diff.height=j.max.height-j.min.height}this._dim=j;return j},_viewportBounds:function(d){if(this.options.fixed){return this._view}else{var c,f=this._view.top,e=this._view.left,g;c={width:Math.round(this._view.width*d.width),height:Math.round(this._view.height*d.height)};if(c.width<c.height){e+=Math.round((c.height-c.width)*0.5)}else{if(c.height<c.width){f+=Math.round((c.width-c.height)*0.5)}}g={top:f,left:e};return a.extend({},c,g)}},_aspectRatio:function(c,d){return{width:c&&d&&c<d?c/d:1,height:c&&d&&d<c?d/c:1}},_zoomDiff:function(){var c=this._dim,d=(this._val*0.01);return{width:Math.round(c.diff.width*d),height:Math.round(c.diff.height*d)}},_size:function(){var d=this._dim,c=this._zoomDiff();return{width:d.min.width+c.width,height:d.min.height+c.height}},_containment:function(){var i=this.element,g=this._size(),d=i.offset().left,f=i.offset().top,h=i.offset().left,c=i.offset().top;d+=(i.outerWidth()-i.width())*0.5;f+=(i.outerHeight()-i.height())*0.5;h+=(i.outerWidth()-i.width())*0.5;c+=(i.outerHeight()-i.height())*0.5;if(g.width<i.width()){wDiff=Math.round((i.width()-g.width)*0.5);d+=wDiff;h+=wDiff}if(g.height<i.height()){hDiff=Math.round((i.height()-g.height)*0.5);f+=hDiff;c+=hDiff}if(g.width>i.width()){d-=g.width-i.width()}if(g.height>i.height()){f-=g.height-i.height()}return[d,f,h,c]},_position:function(){var j=this.element,f=this._size(),k=a(this._img).position(),d,c,i,h,g;d=f.width-a(this._img).width();c=f.height-a(this._img).height();i=d?(-Math.round(d*0.5)+k.left):0;h=c?(-Math.round(c*0.5)+k.top):0;if(f.width<j.width()){i=Math.round((j.width()-f.width)*0.5)}else{if(i>0){i=0}else{if(i<(j.width()-f.width)){i=j.width()-f.width}}}if(f.height<j.height()){h=Math.round((j.height()-f.height)*0.5)}else{if(h>0){h=0}else{if(h<(j.height()-f.height)){h=j.height()-f.height}}}g={left:i,top:h};return g},_disableControl:function(d){if(d){var c=a(d);c.addClass("tzoom-disabled");if(c.draggable){c.draggable("disable")}if(c.slider){c.slider("disable")}if(c.button){c.button("disable")}if(c.is("input")){c.attr("disabled",true)}if(c.is("button")){c.attr("disabled",true)}}},_enableControl:function(d){if(d){var c=a(d);c.removeClass("tzoom-disabled");if(c.draggable){c.draggable("enable")}if(c.slider){c.slider("enable")}if(c.button){c.button("enable")}if(c.is("input")){c.removeAttr("disabled")}if(c.is("button")){c.removeAttr("disabled")}}},_destroyControl:function(d){if(d){var c=a(d);c.removeClass("tzoom-viewport").removeClass("tzoom-image").removeClass("tzoom-image-loading").removeClass("tzoom-image-static").removeClass("tzoom-control").removeClass("tzoom-disabled").removeClass("tzoom-error");if(typeof a.event.special.mousewheel!="undefined"){c.unbind("mousewheel")}if(c.draggable){c.draggable("destroy")}if(c.slider){c.slider("destroy")}if(c.button){c.button("destroy")}}},_clearValues:function(){this._moveSlider(0);this._setDimensions();this._val=0},_clearImage:function(){this._destroyControl(this._img);if(this._img){a(this._img).remove()}if(this.options.lazySrc){delete this.options.lazySrc}this._loadingImage(false);this.element.find(".tzoom-error").remove();delete this._img},_clear:function(){this._clearValues();this.disable();this._clearImage()},value:function(g,f){var e=this,d,c;if(typeof g==="undefined"){return this._val}if(this._disabled){return}if(this.options.onZoom){d=this.options.onZoom.call(this._img,this._val);if(d===false){return}}this._moveSlider(g);if(g>0&&this.isProxy()){this.disable();c=a("<img />");c.attr("src",this.options.lazySrc);if(this._testImage(c)){this._image(c);if(this.options.onLazy){this.options.onLazy.call(c,g)}this._prepareImage(function(){if(e._value(g)){e._zoom(f)}})}}else{if(this._value(g)){this._zoom(f)}}return true},imageSrc:function(e,c){var d=a("<img />");d.attr("src",e);this.image(d,c)},image:function(e,c){var d=false;if(typeof e==="undefined"){return this._img}else{d=this._testImage(e);if(d){this._image(e,c);this._prepareImage()}}},disable:function(){this._disabled=true;this._disableControl(this._img);this._disableControl(this.options.slider);this._disableControl(this.options.decreaseBtn);this._disableControl(this.options.increaseBtn);return this},enable:function(){delete this._disabled;this._enableControl(this._img);this._enableControl(this.options.slider);this._enableControl(this.options.decreaseBtn);this._enableControl(this.options.increaseBtn);return this},destroy:function(){this._clearImage();this._clearValues();this._destroyControl(this._img);this._destroyControl(this.options.slider);this._destroyControl(this.options.descreaseBtn);this._destroyControl(this.options.increaseBtn);this._destroyControl(this.element);return this},isProxy:function(){return this._img&&this.options.lazySrc&&this._img.attr("src")!==this.options.lazySrc}})})(jQuery);